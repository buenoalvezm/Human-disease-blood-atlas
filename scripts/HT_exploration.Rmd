---
title: "HT"
output: html_document
date: "2024-04-24"
editor_options: 
  chunk_output_type: console
---

```{r}
# Load packages
library(tidyverse)
library(arrow)
library(readxl)
library(ggsci)
library(ggbeeswarm)
library(GGally)
library(pheatmap)
library(ggplotify)
library(patchwork)
library(impute)
library(ggrepel)
library(limma)
library(OlinkAnalyze)
library(ggrain)

# Read internal functions
source("scripts/functions_utility.R")
source("scripts/themes_palettes.R")

# Read data
data_ht <- import_df("data/cs-transfer/VL-3530B1_complete_NPX_2024-07-01.parquet")
manifest <- import_df("data/samples_2024-04-19.xlsx")
concentration_info <- import_df("data/concentrations_blood-atlas-build.xlsx")
data_phase1 <-  import_df("data/final_data/data_NPX_cohort.csv")
data_NPX_phase1 <- import_df(file = "data/final_data/final_data_phase1.csv") 

# Targets 3 platforms
targets_ht <- 
  import_df("data/olink_targets/targets_ht.csv")
targets_3072 <- 
  import_df("data/olink_targets/targets_3k.xlsx")
targets_1463 <- 
  data_NPX_phase1 |> 
  distinct(Assay)
targets <-  import_df("data/olink_targets/overlap_olink_platforms.csv")


# HPA
hpa <- read_tsv("data/hpa/proteinatlas.tsv")
cor_proteins <- import_df("data/processed/hooking.correlation.above.0.7.csv")
``` 

# Compare phase 1 and phase 2 assays

```{r}
data_ht |> 
  distinct(Assay, OlinkID) |> 
  filter(Assay == "IL10")
#  filter(OlinkID %in% unique(data_phase1$OlinkID))

data_phase1 |> 
  distinct(Assay, OlinkID)|> 
  filter(Assay == "IL10")
```


# Data overview

```{r}
control_sample_types <- c("SAMPLE_CONTROL", "PLATE_CONTROL", "NEGATIVE_CONTROL")
control_assays <- c("ext_ctrl", "inc_ctrl", "amp_ctrl")

olink_meta <- 
  data_ht |> 
  distinct(Assay, OlinkID, UniProt, AssayType, Block)

# Number of plates per sample
# data_ht |> 
#   filter(SampleType == "SAMPLE") |>
#   separate(SampleID, into = c("DAid", "Plate"), sep = "-", remove = F) |> 
#   group_by(DAid) |> 
#   count(Plate) |> 
#   arrange(-n)

id_mapping <- 
  data_ht |> 
  filter(SampleType == "SAMPLE") |> 
  distinct(SampleID) |> 
  separate(SampleID, into = c("DAid", "Plate"), sep = "-", remove = F) 

data <- 
  data_ht |> 
  filter(SampleType == "SAMPLE") |>
  left_join(id_mapping, by = "SampleID") |> 
  select(DAid, Assay, Count, ExtNPX, NPX, PCNormalizedNPX, SampleQC)

data_controls <- 
  data_ht |> 
  filter(SampleType %in% control_sample_types) |> 
  left_join(id_mapping, by = "SampleID") |> 
  select(SampleID, Assay, Count, ExtNPX, NPX, PCNormalizedNPX, SampleQC)

common_assays <-
  data |>
  distinct(Assay) |>
  filter(Assay %in% unique(data_phase1$Assay)) |>
  pull(Assay)
```

## LOD

### Calculate

```{r}
data_ht_lod <- olink_lod(data = data_ht, lod_method = "NCLOD")


n_samples <- 
  data_ht_lod |> 
  filter(!SampleType %in% control_sample_types,
         !AssayType %in% control_assays,
         !Assay %in% c("GBP1", "MAP2K1")) |> 
  distinct(SampleID) |> 
  nrow()

ht_lod <- 
  data_ht_lod |> 
  filter(!SampleType %in% control_sample_types,
         !AssayType %in% control_assays,
         !Assay %in% c("GBP1", "MAP2K1")) |> 
  mutate(under_LOD = ifelse(NPX < LOD, "Yes", "No")) |> 
  group_by(Assay) |> 
  count(under_LOD, .drop = FALSE) |> 
  filter(under_LOD == "Yes") |> 
  mutate(Percentage_under_LOD = (n / n_samples)* 100)  |> 
  left_join(data_ht |> 
              distinct(Assay, Block), by = "Assay") 
```

### Histogram & density

```{r}
ht_lod |> 
  ggplot(aes(Percentage_under_LOD)) +
  geom_density() +
  theme_hpa()

phase1_lod |> 
  ggplot(aes(Percentage_under_LOD)) +
  geom_histogram() +
  theme_hpa() +
  ylab("Number of proteins")
```


### Blocks & Explore

```{r}
bloc_lod <- 
  ht_lod |> 
  ggplot(aes(Block, 
             Percentage_under_LOD, 
             color = Block)) +
  geom_quasirandom() +
  geom_violin(fill = NA, 
              color = "black",
              draw_quantiles = 0.5) +
  scale_color_brewer(direction = -1) +
  theme_hpa()

# In 1,5K or not
explore_lod <- 
  ht_lod |> 
  mutate(Olink_Explore_1463 = ifelse(Assay %in% common_assays, "Yes", "No")) |> 
  ggplot(aes(Olink_Explore_1463, 
             Percentage_under_LOD, 
             color = Olink_Explore_1463)) +
  geom_quasirandom() +
  geom_violin(fill = NA, 
              color = "black",
              draw_quantiles = 0.5) +
  theme_hpa()

bloc_lod + explore_lod
ggsave(savepath("lod.png"), h = 5, w = 10)  
```
### Across platforms

```{r}
ht_lod |> 
  filter(!Assay %in% control_assays) |>
  left_join(targets, by = "Assay") |> 
  filter(!is.na(Platform)) |> 
  ggplot(aes(Percentage_under_LOD, fill = Platform)) +
  geom_histogram() +
  scale_fill_manual(values = pal_platforms) +
  theme_hpa()

ggsave(savepath("LOD_platform.png"), h = 5, w = 6)

ht_lod |> 
  filter(!Assay %in% control_assays) |>
  left_join(targets, by = "Assay") |> 
  filter(!is.na(Platform)) |> 
  ggplot(aes(Percentage_under_LOD, fill = Platform)) +
  geom_histogram() +
  facet_wrap(~Platform, ncol = 1) +
  scale_fill_manual(values = pal_platforms) +
  theme_hpa()

ggsave(savepath("LOD_platform_facet.png"), h = 7, w = 6)
```

### Secretome

```{r}
ht_lod |> 
  mutate(Percentage_under_LOD = case_when(
    Percentage_under_LOD >= 0 & Percentage_under_LOD < 25 ~ "0-25%",
    Percentage_under_LOD >= 25 & Percentage_under_LOD < 50 ~ "25-50%",
    Percentage_under_LOD >= 50 & Percentage_under_LOD < 75 ~ "50-75%",
    Percentage_under_LOD >= 75 & Percentage_under_LOD <= 100 ~ "75-100%"
  )) |> 
  left_join(hpa |> 
              select(Gene, `Secretome location`), by = c("Assay" = "Gene")) |> 
  group_by(Percentage_under_LOD, `Secretome location`) |>
  count() |> 
  ggplot(aes(Percentage_under_LOD, n, fill = `Secretome location`)) +
  geom_col() +
  scale_fill_manual(values = pal_secreted) +
  theme_hpa(angled = T) +
  ggtitle("HT assays (n = 5083)")

ggsave(savepath("assays_lod_ht_secretome.png"), h = 5, w = 6)


targets_ht_only <- 
  olink_targets |> 
  filter(Platform == "HT") |> 
  pull(Assay)

ht_lod |> 
  filter(Assay %in% targets_ht_only) |> 
  mutate(Percentage_under_LOD = case_when(
    Percentage_under_LOD >= 0 & Percentage_under_LOD < 25 ~ "0-25%",
    Percentage_under_LOD >= 25 & Percentage_under_LOD < 50 ~ "25-50%",
    Percentage_under_LOD >= 50 & Percentage_under_LOD < 75 ~ "50-75%",
    Percentage_under_LOD >= 75 & Percentage_under_LOD <= 100 ~ "75-100%"
  )) |> 
  left_join(hpa |> 
              select(Gene, `Secretome location`), by = c("Assay" = "Gene")) |> 
  group_by(Percentage_under_LOD, `Secretome location`) |>
  count() |> 
  ggplot(aes(Percentage_under_LOD, n, fill = `Secretome location`)) +
  geom_col() +
  scale_fill_manual(values = pal_secreted) +
  theme_hpa(angled = T) +
  ggtitle("Added HT assays (n = 2506)")

ggsave(savepath("assays_lod_ht_added_secretome.png"), h = 5, w = 6)
```


### Check if LOD is random

```{r}
assays_above_75 <- 
  ht_lod |> 
  filter(Percentage_under_LOD > 75) |>
  pull(Assay)

phase2_lod_disease_dat <- 
  data_ht_lod |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(!AssayType %in% control_assays) |> 
  select(DAid, Assay, NPX, LOD) |> 
  mutate(under_LOD = ifelse(NPX < LOD, "Yes", "No")) |> 
  left_join(manifest |> 
              mutate(Disease = paste(Cohort,Diagnose,sep = "_")) |> 
              select(DAid, Disease), by = "DAid")  |> 
  group_by(Disease) |> 
  mutate(n = n_distinct(DAid)) 

samples_disease <- 
  phase2_lod_disease_dat |> 
  filter(!is.na(Disease),
         Disease != "CTRL_NA",
         !Assay %in% replicate_assays,
         !grepl("back-up", Disease)) |>
  distinct(Disease, n)

phase2_lod_disease <- 
  phase2_lod_disease_dat |>
  filter(!is.na(Disease),
         Disease != "CTRL_NA",
         !Assay %in% replicate_assays,
         !grepl("back-up", Disease)) |> 
  group_by(Assay, Disease) |> 
  count(under_LOD, .drop = FALSE) |> 
  filter(under_LOD == "Yes") |>
  rename(n_under = n) |> 
  left_join(samples_disease, by = "Disease") |> 
  mutate(Percentage_under_LOD = (n_under / n)* 100)  |> 
  arrange(-Percentage_under_LOD)

annotation <- 
  manifest |> 
  mutate(Disease = paste(Cohort,Diagnose,sep = "_"),
         Cohort = paste(Cohort,`PI - sample owner`,sep = "_")) |>
  filter(DAid %in% phase2_lod_disease_dat$DAid) |> 
  distinct(Disease, Cohort) |> 
  column_to_rownames("Disease")


phase2_lod_disease |> 
  filter(Assay %in% assays_above_75) |> 
  filter(!is.na(Disease)) |> 
  select(Assay, Disease, Percentage_under_LOD) |>
  pivot_wider(names_from = Assay, 
              values_from = Percentage_under_LOD,
              values_fill = 0) |> 
  column_to_rownames("Disease") |> 
  t() |> 
  pheatmap(color=colorRampPalette(c("navy", "white"))(50),
           annotation_col = annotation,
           show_rownames = F,
           annotation_colors = list("Cohort" = pal_phase2)) |> 
  as.ggplot() +
  ggtitle("2802 proteins with >75% of values under LOD")

ggsave(savepath("heatmap_LOD_P2.png"), h = 6, w = 8)


phase2_lod_disease |> 
  filter(Percentage_under_LOD < 50) |> 
  ungroup() |> 
  distinct(Assay)

#2803 - 2358

proteins_include <- 
  phase2_lod_disease |> 
  filter(Percentage_under_LOD < 75) |> 
  ungroup() |> 
  distinct(Assay) |> 
  pull()

phase2_lod_disease |> 
  filter(#Assay %in% assays_above_75,
         Assay %in% proteins_include,
         !is.na(Disease)) |> 
  select(Assay, Disease, Percentage_under_LOD) |> 
  pivot_wider(names_from = Assay, 
              values_from = Percentage_under_LOD,
              values_fill = 0) |> 
  column_to_rownames("Disease") |> 
  t() |> 
  pheatmap(color=colorRampPalette(c("navy", "white"))(50),
           annotation_col = annotation,
           show_rownames = F,
           annotation_colors = list("Cohort" = pal_phase2)) |> 
  as.ggplot() +
  ggtitle("2832 proteins with < 75% of values under LOD in at least one disease")

ggsave(savepath("heatmap_LOD_P2_include_disease_75.png"), h = 6, w = 8)


```

### General heatmap

```{r}

# Secretome & overall LOD
annotation_col <- 
  ht_lod |> 
  select(Assay, Percentage_under_LOD, Block) |> 
  left_join(hpa |> 
              select(Gene, `Secretome location`), by = c("Assay" = "Gene")) |> 
  mutate(`Secretome location` = ifelse(is.na(`Secretome location`), "Unknown", `Secretome location`)) |> 
  mutate(Block = as.numeric(Block)) |> 
  column_to_rownames("Assay")

phase2_lod_disease |> 
  filter(!is.na(Disease)) |> 
  select(Assay, Disease, Percentage_under_LOD) |> 
  pivot_wider(names_from = Assay, 
              values_from = Percentage_under_LOD,
              values_fill = 0) |> 
  column_to_rownames("Disease") |> 
 # t() |> 
  pheatmap(color=colorRampPalette(c("grey40", "white"))(50),
           annotation_row = annotation,
           annotation_col = annotation_col,
           show_colnames = F,
           cutree_cols = 4,
           annotation_colors = list("Cohort" = pal_phase2,
                                    "Secretome location" = pal_secreted)) |> 
  as.ggplot() 

ggsave(savepath("heatmap_LOD_P2_all.png"), h = 4, w = 12)

```



```{r}
ht_lod |> 
  ggplot(aes(Percentage_under_LOD)) +
  geom_histogram() +
  theme_hpa()


ht_lod |> 
    mutate(Olink_Explore_1463 = ifelse(Assay %in% common_assays, "Yes", "No")) |> 
  ggplot(aes(Percentage_under_LOD, fill = Olink_Explore_1463)) +
  geom_histogram() +
  facet_wrap(~Olink_Explore_1463, ncol = 1) +
  theme_hpa()
 
ggsave(savepath("histogram_lod_explore.png"), h = 7, w = 5)

ht_lod |> 
  ggplot(aes(Percentage_under_LOD, fill = Block)) +
  geom_histogram() +
  scale_fill_brewer(direction = -1) +
  facet_wrap(~Block, ncol = 1) +
  theme_hpa()

ggsave(savepath("histogram_lod_blocks.png"), h = 9, w = 5)
```


## Blocks

```{r}
# Blocks
data_ht |> 
  distinct(Assay, Block) |> 
  count(Block) |> 
  ggplot(aes(Block, n, fill = Block)) +
  geom_col() +
  geom_text(aes(label = n, y = n + 20)) +
  scale_fill_brewer(direction = -1) +
  theme_hpa()

ggsave(savepath("blocks.png"), h = 5, w = 5)


data_ht |> 
  distinct(Assay, Block) |> 
  left_join(concentration_info, by = c("Assay" = "Gene")) |> 
  filter(!is.na(`ng/L`)) |> 
  ggplot(aes(Block, log2(`ng/L`), color = Block, fill = Block)) +
  geom_quasirandom() +
  geom_boxplot(alpha = 0.5, outlier.color = NA) +
  scale_color_brewer(direction = -1) +
  scale_fill_brewer(direction = -1) +
  theme_hpa()

ggsave(savepath("blocks_concentration.png"), h = 5, w = 5)
```

## Plates

```{r}

```

## Assay warning

```{r}
data |> 
  distinct(SampleID) |> 
  nrow()

data_ht |>
  group_by(Assay) |> 
  count(AssayQC) |> 
  filter(!AssayQC %in% c("NA", "PASS")) |> 
  arrange(-n) |> 
  ggplot(aes(fct_reorder(Assay,-n), n)) +
  geom_col() +
  geom_text(aes(label = n), vjust = -0.5) +
  theme_hpa(angle = T) +
  xlab("Assay")

ggsave(savepath("assay_qc.png"), h = 5, w = 10)

# Check the types of samples where they are missing

```


## QC warning

```{r}
data |> 
  distinct(SampleID) |> 
  nrow()

data |> 
  group_by(DAid) |> 
  count(SampleQC) |> 
  filter(!SampleQC %in% c("NA", "PASS")) |> 
  arrange(-n) |> filter (n<500) 
  left_join(manifest, by = "DAid") |> 
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_")) |>
  ggplot(aes(fct_reorder(DAid, -n), n, fill = Cohort)) +
  geom_col() +
  scale_fill_manual(values = pal_phase2) +
  geom_hline(yintercept = 5440/2, linetype = "dashed", color = "grey") +
  xlab("Sample") +
  theme_hpa(angled = T) +
  ggtitle("Samples with QC warnings")

ggsave(savepath("samples_qc.png"), h = 4, w = 10)
```

## Replicate assys

```{r}

replicate_assays <- 
  data |>  
  group_by(Assay) |> 
  count() |> 
  arrange(-n) |> 
  filter(n > 2500) |> 
  pull(Assay)

data_ht |> 
  filter(Assay == "GBP1",
         SampleType == "SAMPLE") |> 
  select(OlinkID, PCNormalizedNPX, SampleID) |> 
  pivot_wider(names_from = OlinkID, values_from = PCNormalizedNPX) |> 
  left_join(id_mapping, by = "SampleID") |> 
  left_join(manifest, by = "DAid") |> 
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_")) |>
  ggpairs(2:4, title = "GBP1",
          mapping = ggplot2::aes(color = Cohort)) +
  scale_fill_manual(values = pal_phase2) +
  scale_color_manual(values = pal_phase2) +
  theme_hpa() 

ggsave(savepath("GBP1_replicates.png"), h = 8, w = 8)
  
data_ht |> 
  filter(Assay == "MAP2K1",
         SampleType == "SAMPLE") |> 
  select(OlinkID, PCNormalizedNPX, SampleID) |> 
  pivot_wider(names_from = OlinkID, values_from = PCNormalizedNPX) |> 
  left_join(id_mapping, by = "SampleID") |> 
  left_join(manifest, by = "DAid") |> 
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_")) |>
  ggpairs(2:4, title = "MAP2K1",
          mapping = ggplot2::aes(color = Cohort)) +
  scale_fill_manual(values = pal_phase2) +
  scale_color_manual(values = pal_phase2) +
  theme_hpa() 

ggsave(savepath("MAP2K1_replicates.png"), h = 8, w = 8)


# Intensity
data_ht |> 
  filter(Assay == "GBP1",
         SampleType == "SAMPLE") |> 
  select(OlinkID, NPX, SampleID) |> 
  pivot_wider(names_from = OlinkID, values_from = NPX) |> 
  left_join(id_mapping, by = "SampleID") |> 
  left_join(manifest, by = "DAid") |> 
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_")) |>
  ggpairs(2:4, title = "GBP1",
          mapping = ggplot2::aes(color = Cohort)) +
  scale_fill_manual(values = pal_phase2) +
  scale_color_manual(values = pal_phase2) +
  theme_hpa() 

ggsave(savepath("GBP1_replicates_IN.png"), h = 8, w = 8)
  
data_ht |> 
  filter(Assay == "MAP2K1",
         SampleType == "SAMPLE") |> 
  select(OlinkID, NPX, SampleID) |> 
  pivot_wider(names_from = OlinkID, values_from = NPX) |> 
  left_join(id_mapping, by = "SampleID") |> 
  left_join(manifest, by = "DAid") |> 
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_")) |>
  ggpairs(2:4, title = "MAP2K1",
          mapping = ggplot2::aes(color = Cohort)) +
  scale_fill_manual(values = pal_phase2) +
  scale_color_manual(values = pal_phase2) +
  theme_hpa() 

ggsave(savepath("MAP2K1_replicates_IN.png"), h = 8, w = 8)
```




# Overview cohort

## Number of samples

```{r}
data |> 
  distinct(DAid) |> 
  nrow()

manifest |> 
  filter(Cohort %in% c("BAMS", "BRDG2", "EPIL", "FIBR", "PARD", "PREG", "WELL", "CTRL")) |> nrow()

data |> 
  distinct(DAid) |> 
  left_join(manifest, by = "DAid") |> 
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_")) |>
  count(Cohort) |> 
  ggplot(aes(Cohort, n, fill = Cohort)) +
  geom_col() +
  scale_fill_manual(values = pal_phase2) +
  geom_text(aes(label = n), vjust = -0.5) +
  theme_hpa(angled = T) +
  ylab("Number of samples")

ggsave(savepath("da_phase2_cohorts.png"), h = 6, w = 6)
```


# Replicate samples

## Bridging samples

```{r}
manifest |> 
  distinct(`Vial barcode`, DAid, Cohort) |> 
  group_by(`Vial barcode`) |> 
  count(DAid) |>
  arrange(-n)

bridging_samples <- 
  manifest |> 
  filter(DAid %in% data$DAid) |> 
  filter(Cohort == "BDG2") 

bridging_p2 <- 
  bridging_samples |> 
  select(DAid, `Vial barcode`, `Extra data`) |> 
  separate(`Extra data`, sep = "\n", into = c("Original", "Other")) |> 
  mutate(Original = str_remove(Original, "label: ")) |> 
  select(DAid, `Vial barcode` = Original) |> 
  filter(`Vial barcode` != "NA",
         !is.na(`Vial barcode`))

bridging_p1 <- 
  manifest |> 
  filter(`Vial barcode` %in% bridging_p2$`Vial barcode`,
         Cohort != "ANMU") #Duplicated vial nr 


replicate_proteins <- c("IL6", "TNF", "CXCL8", "GBP1", "MAP2K1")

common_assays <- 
  data |> 
  distinct(Assay) |> 
  filter(!Assay %in% control_assays,
         !Assay %in% replicate_proteins,
         Assay %in% data_phase1$Assay) |> 
  pull(Assay)

data_bridging_p1 <- 
  data_phase1 |> 
  left_join(manifest |> 
              distinct(DAid, `Vial barcode`, by = "DAid")) |> 
  filter(`Vial barcode` %in% bridging_p1$`Vial barcode`,
         Assay %in% common_assays) |> 
  select(ID = `Vial barcode`, Assay, NPX_P1 = NPX)

data_bridging_p2 <- 
  data |> 
  left_join(bridging_p2 |> 
              distinct(DAid, `Vial barcode`, by = "DAid")) |> 
  filter(DAid %in% bridging_p2$DAid,
         Assay %in% common_assays) |> 
  select(ID = `Vial barcode`, Assay, NPX_P2 = NPX)

data_bridging_p1 |> 
  distinct(ID)
data_bridging_p2 |> 
  distinct(ID)
data_bridging_p1 |> 
  distinct(Assay)
data_bridging_p2 |> 
  distinct(Assay)

# Correlations
combined_p1_p2 <- 
  data_bridging_p1 |> 
  left_join(data_bridging_p2, by = c("ID", "Assay"))

cor_p1_p2 <- 
  combined_p1_p2 |> 
  group_by(Assay) |>
  summarize(cor = cor(NPX_P1, NPX_P2)) |> 
  arrange(cor) |> 
  left_join(olink_meta, by = "Assay") 

cor_p1_p2 |>
  ggplot(aes("Proteins", cor, color = Block)) +
  geom_beeswarm() +
  geom_text_repel(aes(label = Assay), show.legend = F, size = 3) +
  scale_color_brewer(direction = -1) +
  xlab("") +
  ylab("Correlation P1 - P2") +
  theme_hpa()

ggsave(savepath("cor_distribution.png"), h = 9 , w = 8)

above <- 
  cor_p1_p2 |> 
  filter(cor > 0.8) |> 
  nrow()

cor_p1_p2 |>
  ggplot(aes(cor)) +
  geom_density(fill = "lightgrey") +
  geom_vline(xintercept = 0.8, color = "red", lty = "dashed") +
  geom_text(aes(x = 0.95, y = 9, label = paste(above, " proteins")), color = "red") +
  #geom_text_repel(aes(label = Assay), show.legend = F, size = 3) +
  #scale_color_brewer(direction = -1) +
#  xlab("") +
#  ylab("Correlation P1 - P2") +
  theme_hpa()

ggsave(savepath("cor_distribution_2.png"), h = 6 , w = 8)


highest <-
  cor_p1_p2 |> 
  arrange(-cor) |> 
  head(5)
  
lowest <-
  cor_p1_p2 |> 
  arrange(cor) |> 
  head(5)
  
library(ggpubr)
p1 <- 
  combined_p1_p2 |> 
  filter(Assay %in% highest$Assay) |>
  ggplot(aes(NPX_P1, NPX_P2)) +
  geom_point() +
  geom_smooth(method = "lm", color = "grey") +
  #geom_cor +
  stat_cor(method = "spearman") +
  facet_wrap(~Assay, scales = "free", nrow = 1) +
  theme_hpa() 
  
p2 <- 
  combined_p1_p2 |> 
  filter(Assay %in% lowest$Assay) |>
  ggplot(aes(NPX_P1, NPX_P2)) +
  geom_point() +
  geom_smooth(method = "lm", color = "grey") +
  #geom_cor +
  stat_cor(method = "spearman") +
  facet_wrap(~Assay, scales = "free", nrow = 1) +
  theme_hpa() 

p1 / p2
ggsave(savepath("correlations_highest_lowest.png"), h = 8, w = 10)

# Cluster 1 proteins
cor_proteins <- read_csv("data/processed/hooking.correlation.above.0.7.csv")

cor_p1_p2 |>
  mutate(Excluded_phase_1 = ifelse(Assay %in% cor_proteins$value, "Yes", "No")) |> 
  ggplot(aes("Proteins", cor, color = Excluded_phase_1)) +
  geom_beeswarm(alpha = 0.7) +
  geom_text_repel(aes(label = Assay), show.legend = F, size = 3) +
  scale_color_manual(values = c("Yes" = "red", "No" = "grey")) +
  xlab("") +
  ylab("Correlation P1 - P2") +
  theme_hpa()

ggsave(savepath("cor_distribution_excluded.png"), h = 9 , w = 8)

# Percentage under LOD
cor_p1_p2 |>
  left_join(ht_lod, by = "Assay") |> 
  ggplot(aes("Proteins", cor, color = Percentage_under_LOD)) +
  geom_beeswarm(alpha = 0.7) +
  geom_text_repel(aes(label = Assay), show.legend = F, size = 3) +
 # scale_color_manual(values = c("Yes" = "red", "No" = "grey")) +
  xlab("") +
  ylab("Correlation P1 - P2") +
  theme_hpa()

ggsave(savepath("cor_distribution_lod.png"), h = 9 , w = 8)


cor_p1_p2 |>
  left_join(ht_lod, by = "Assay") |> 
  mutate(`below_LOD_in_50%` = ifelse(Percentage_under_LOD > 50, "Yes", "No")) |>
  ggplot(aes("Proteins", cor, color = `below_LOD_in_50%`)) +
  geom_beeswarm(alpha = 0.7) +
  geom_text_repel(aes(label = Assay), show.legend = F, size = 3) +
  scale_color_manual(values = c("Yes" = "red", "No" = "grey")) +
  xlab("") +
  ylab("Correlation P1 - P2") +
  theme_hpa()

ggsave(savepath("cor_distribution_lod_binary.png"), h = 9 , w = 8)


```

### Correlation - LOD

```{r}

cor_p1_p2 |> 
  left_join(ht_lod |> 
              select(Assay, Percentage_under_LOD), by = "Assay") |> 
  ggplot(aes(cor, Percentage_under_LOD, color = Block)) +
  geom_point() +
  scale_color_brewer(direction = -1) +
  theme_hpa()

ggsave(savepath("correlation_lod.png"), h = 6, w = 6)

cor_p1_p2 |> 
  left_join(ht_lod |> 
              select(Assay, Percentage_under_LOD), by = "Assay") |>
  mutate(Pre_analytical_variation = ifelse(Assay %in% cor_proteins$value, "Yes", "No")) |>
  ggplot(aes(cor, Percentage_under_LOD, color = Pre_analytical_variation)) +
  geom_point() +
  scale_color_manual(values = pal_binary) +
  theme_hpa()

ggsave(savepath("correlation_lod_preanalytical.png"), h = 6, w = 6)
```


BDG2_Fredrik Edfors -> DAid not in manifest


## Controls

```{r}
control_samples <- 
  manifest |> 
  filter(DAid %in% data$DAid) |> 
  filter(Cohort == "CTRL") |> 
  pull(DAid)

#Patient 2 - DA12362
#Patient 3 - DA12363

id_mapping |> 
  group_by(DAid) |> 
  summarize(n = n_distinct(Plate)) |> 
  arrange(-n)
  
data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12362") |> 
  select(Plate, OlinkID, PCNormalizedNPX) |> 
  pivot_wider(names_from = OlinkID, values_from = PCNormalizedNPX) |> 
  column_to_rownames("Plate") |> 
  t() |> 
  cor(method = "spearman")|> 
  pheatmap() |> 
  as.ggplot() +
  ggtitle("Correlation for Patient 2 measurements across plates") +
  theme(plot.title = element_text(face = "bold", size = rel(1))) +

data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12363") |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = OlinkID, values_from = NPX) |> 
  column_to_rownames("Plate") |> 
  t() |> 
  cor(method = "spearman")|> 
  pheatmap() |> 
  as.ggplot() +
  ggtitle("Correlation for Patient 3 measurements across plates") +
  theme(plot.title = element_text(face = "bold", size = rel(1))) 

ggsave(savepath("plate_controls.png"), h = 6, w = 12)

data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12362") |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = Plate, values_from = NPX) |> 
  ggpairs(c(2:13),
            lower = list(continuous = "points", size = 0.05)) +
  ggtitle("Correlation for Patient 2 measurements across plates") 

ggsave(savepath("p2_plate_scatterplots.png"), h = 10, w = 10)

data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12363") |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = Plate, values_from = NPX) |> 
  ggpairs(c(2:13),
            lower = list(continuous = "points", size = 0.5)) +
  ggtitle("Correlation for Patient 3 measurements across plates")

ggsave(savepath("p3_plate_scatterplots.png"), h = 10, w = 10)


#

# Correlate against random sample

# Take two plates, heatmpas → correlation all samples all plates → stand out as better? Mizup in plate orientation?

# Plot per bloc


# Plot only with 1,5K
prots_phase1 <- 
  data_NPX_phase1 |> 
  distinct(Assay) |> 
  pull()

data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12362") |> 
  filter(Assay %in% prots_phase1) |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = OlinkID, values_from = NPX) |> 
  column_to_rownames("Plate") |> 
  t() |> 
  cor(method = "spearman")|> 
  pheatmap() |> 
  as.ggplot() +
  ggtitle("Correlation for Patient 2 measurements across plates") +
  theme(plot.title = element_text(face = "bold", size = rel(1))) +

data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12363") |> 
  filter(Assay %in% prots_phase1) |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = OlinkID, values_from = NPX) |> 
  column_to_rownames("Plate") |> 
  t() |> 
  cor(method = "spearman")|> 
  pheatmap() |> 
  as.ggplot() +
  ggtitle("Correlation for Patient 3 measurements across plates") +
  theme(plot.title = element_text(face = "bold", size = rel(1))) 

ggsave(savepath("plate_controls_in_explore.png"), h = 6, w = 12)


data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12362") |> 
  filter(!Assay %in% prots_phase1) |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = OlinkID, values_from = NPX) |> 
  column_to_rownames("Plate") |> 
  t() |> 
  cor(method = "spearman")|> 
  pheatmap() |> 
  as.ggplot() +
  ggtitle("Correlation for Patient 2 measurements across plates") +
  theme(plot.title = element_text(face = "bold", size = rel(1))) +

data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12363") |> 
  filter(!Assay %in% prots_phase1) |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = OlinkID, values_from = NPX) |> 
  column_to_rownames("Plate") |> 
  t() |> 
  cor(method = "spearman")|> 
  pheatmap() |> 
  as.ggplot() +
  ggtitle("Correlation for Patient 3 measurements across plates") +
  theme(plot.title = element_text(face = "bold", size = rel(1))) 

ggsave(savepath("plate_controls_not_in_explore.png"), h = 6, w = 12)

data_ht |> 
  filter(Assay %in% prots_phase1) |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12363") |> 
  select(Plate, OlinkID, PCNormalizedNPX) |> 
  pivot_wider(names_from = Plate, values_from = PCNormalizedNPX) |> 
  ggpairs(c(2:13),
            lower = list(continuous = "points", size = 0.5)) +
  ggtitle("Correlation for Patient 3 measurements across plates")

#
data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12362",
         Assay %in% prots_phase1) |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = Plate, values_from = NPX) |> 
  ggpairs(c(2:13),
            lower = list(continuous = "points", size = 0.05)) +
  ggtitle("Correlation for Patient 2 measurements across plates") 

ggsave("results/p2_plate_scatterplots_phase1_explore15.png", h = 10, w = 10)


data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12362",
         !Assay %in% prots_phase1) |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = Plate, values_from = NPX) |> 
  ggpairs(c(2:13),
            lower = list(continuous = "points", size = 0.05)) +
  ggtitle("Correlation for Patient 2 measurements across plates") 

ggsave("results/p2_plate_scatterplots_phase1_no_explore15.png", h = 10, w = 10)



data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12363",
         Assay %in% prots_phase1) |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = Plate, values_from = NPX) |> 
  ggpairs(c(2:13),
            lower = list(continuous = "points", size = 0.5)) +
  ggtitle("Correlation for Patient 3 measurements across plates")

ggsave("results/p3_plate_scatterplots_phase1_explore15.png", h = 10, w = 10)

data_ht |> 
  left_join(id_mapping, by = "SampleID") |> 
  filter(DAid == "DA12363",
         !Assay %in% prots_phase1) |> 
  select(Plate, OlinkID, NPX) |> 
  pivot_wider(names_from = Plate, values_from = NPX) |> 
  ggpairs(c(2:13),
            lower = list(continuous = "points", size = 0.5)) +
  ggtitle("Correlation for Patient 3 measurements across plates")

ggsave("results/p3_plate_scatterplots_phase1_no_explore15.png", h = 10, w = 10)
```

## Raincloud per plate

```{r}
raincloud_data <- 
  data |> 
  filter(!Assay %in% control_assays,
         !DAid %in% c("DA12362", "DA12363")) |> 
  left_join(id_mapping, by = "DAid") |> 
  group_by(Plate, Assay) |> 
  summarise(avg_NPX = mean(PCNormalizedNPX))

labels <- 
  raincloud_data |> 
  group_by(Plate) |> 
  top_n(3, -avg_NPX) |> 
  bind_rows(
  raincloud_data |> 
  group_by(Plate) |> 
  top_n(3, avg_NPX))

raincloud_data |> 
  ggplot(aes(x = Plate, y = avg_NPX, fill = Plate, color = Plate)) +
  geom_rain(rain.side = 'l', alpha = 0.6, 
            boxplot.args.pos = list(position = ggpp::position_dodgenudge(x = .095), width = .1)) +
 # scale_color_aaas() +
#  scale_fill_aaas() + 
  geom_text(data = labels, aes(label = Assay)) +
  theme_hpa() +
  ggtitle("Disease Atlas Phase 2 Delivery 1 - NPX distribution per plate") 

ggsave(savepath("raincloud_plate.png"), h = 9, w = 20)


```

# Pre-analytical variation exploration

```{r}

ann <- 
  manifest |> 
  filter(DAid %in% data$DAid) |> 
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_")) |> 
  select(DAid, Cohort) |> 
  column_to_rownames("DAid")

data |> 
  filter(Assay %in% cor_proteins$value,
         !DAid %in% control_samples) |> 
  select(DAid, Assay, NPX) |> 
  pivot_wider(names_from = Assay, values_from = NPX)  |> 
  column_to_rownames("DAid") |> 
  scale() |> 
  pheatmap(show_colnames = F, 
           show_rownames = F,
           clustering_method = "ward.D2",
           annotation_row =  ann,
           annotation_colors = list("Cohort" = pal_phase2)) |> 
  as.ggplot()

ggsave(savepath("prenalytical_proteins_ht.png"), h = 7, w = 10)

data |> 
  filter(!Assay %in% cor_proteins$value,
         !Assay %in% replicate_assays,
         !DAid %in% control_samples) |> 
  select(DAid, Assay, NPX) |> 
  pivot_wider(names_from = Assay, values_from = NPX)  |> 
  column_to_rownames("DAid") |> 
  #scale() |> 
  pheatmap(show_colnames = F, 
           show_rownames = F,
           clustering_method = "ward.D2",
           annotation_row =  ann,
           annotation_colors = list("Cohort" = pal_phase2)) |> 
  as.ggplot()

ggsave(savepath("no_prenalytical_proteins_ht.png"), h = 7, w = 10)

plot_boxplot(proteins = "TRAF2", 
             data = data,
             metadata = manifest, 
             platform = "HT",
             title = "Example protein")
```


# General analyses

## PCA

```{r}

```

## UMAP

### UMAP for all proteins

```{r}
data_ht |> 
  distinct(SampleID) |> 
  nrow()

#proteins_missing_less80 <- 
data_ht |> 
  filter(SampleQC == "PASS") |> 
  group_by(Assay) |> 
  summarize(n = n_distinct(SampleID)) |> 
  filter(n > 537) 

umap_data_PC <- 
  data_ht |>
  filter(SampleType == "SAMPLE", 
         !Assay %in% control_assays) |> 
  left_join(id_mapping, by = "SampleID") |>
  filter(!DAid %in% c("DA12362","DA12363", "DA10197")) |> 
  select(DAid, OlinkID, PCNormalizedNPX) |>
  pivot_wider(names_from = "OlinkID", values_from = "PCNormalizedNPX") |> 
  impute_values(ID = "DAid", wide_data = T) |> 
  column_to_rownames("DAid") |> 
  do_umap() |> 
  rownames_to_column("DAid") 

umap_data <- 
  data_ht |>
  filter(SampleType == "SAMPLE", 
         !Assay %in% control_assays) |> 
  left_join(id_mapping, by = "SampleID") |>
  filter(!DAid %in% c("DA12362","DA12363","DA10197")) |> 
  select(DAid, OlinkID, NPX) |>
  pivot_wider(names_from = "OlinkID", values_from = "NPX") |> 
  impute_values(ID = "DAid", wide_data = T) |> 
  column_to_rownames("DAid") |> 
  do_umap() |> 
  rownames_to_column("DAid") 


p1 <- 
  umap_data_PC|> 
  left_join(manifest, by = "DAid") |> 
  left_join(id_mapping, by = "DAid") |>
  ggplot(aes(UMAP1, UMAP2, color = Plate)) +
  geom_point(size = 0.5) +
  theme_hpa() +
  coord_fixed() +
  ggtitle("Plate control normalization") 

p2 <- 
  umap_data|> 
  left_join(manifest, by = "DAid") |> 
  left_join(id_mapping, by = "DAid") |>
  ggplot(aes(UMAP1, UMAP2, color = Plate)) +
  geom_point(size = 0.5) +
  theme_hpa() +
  coord_fixed() +
  ggtitle("Intensity normalization") 
  
p3 <- 
  ggplot() + theme_void()
  
p4 <- 
  umap_data|> 
  left_join(manifest, by = "DAid") |> 
  left_join(id_mapping, by = "DAid") |>
  mutate(Cohort = paste(Cohort, `PI - sample owner`,  sep = "_")) |> 
  ggplot(aes(UMAP1, UMAP2, color = Cohort)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = pal_phase2) +
  theme_hpa() +
  coord_fixed() +
  ggtitle("Intensity normalization") 

(p1 | p2)

ggsave(savepath("UMAP_HT_normalizations.png"), h = 8, w = 10)




p4
ggsave(savepath("UMAP_intensity_normalization_cohorts.png"), h = 8, w = 8)

c("Pancreatic cancer" = "#01395E",
    "Healthy" = "#8DC3AF", 
    "Streptococcal" = "#FCC174",
    "Influenza" = "#F8ACAC", 
    "Malaria" = "#9E0142")

umap_data|> 
  left_join(manifest, by = "DAid") |> 
  left_join(id_mapping, by = "DAid") |>
  mutate(Cohort = paste(Cohort, `PI - sample owner`,  sep = "_"),
         BAMSE_Diagnose = ifelse(Cohort == "BAMS_Erik Melén", Diagnose, "Other")) |>
  ggplot(aes(UMAP1, UMAP2, color = BAMSE_Diagnose)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = c("Other" = "grey",
                                "4_random"   = "#9E0142",
                                "4_back-up" = "#9E0142",
                                "4_low_lung_function" = "#9E0142",
                                "8_random" = "#F8ACAC",
                                "8_back-up" = "#F8ACAC",
                                "8_low_lung_function" = "#F8ACAC",
                                "16_random" = "#FCC174",
                                "16_back-up" = "#FCC174", 
                                "16_low_lung_function" = "#FCC174",
                                "24_random" = "#8DC3AF",
                                "24_back-up" = "#8DC3AF",
                                "24_low_lung_function" = "#8DC3AF")) +
  theme_hpa() +
  coord_fixed() +
  ggtitle("Intensity normalization")  +

  umap_data|> 
  left_join(manifest, by = "DAid") |> 
  left_join(id_mapping, by = "DAid") |>
  mutate(Cohort = paste(Cohort, `PI - sample owner`,  sep = "_"),) |>
  ggplot(aes(UMAP1, UMAP2, color = Age)) +
  geom_point(size = 0.5) +
  theme_hpa() +
  coord_fixed() +
  ggtitle("Intensity normalization") 

ggsave(savepath("UMAP_HT_BAMSE.png"), h = 8, w = 10)
```

### tidymodels

```{r}
input_umap_data <- 
  data_ht |>
  filter(SampleType == "SAMPLE", 
         !Assay %in% control_assays) |> 
  left_join(id_mapping, by = "SampleID") |>
  filter(!DAid %in% c("DA12362","DA12363","DA10197")) |> 
  select(DAid, OlinkID, NPX) |>
  pivot_wider(names_from = "OlinkID", values_from = "NPX")

umap_all_proteins <- 
  do_umap(data = input_umap_data,
        meta = manifest, 
        variable = Disease,
        plots = T)

umap_all_proteins

```

# Protein co-expression

## Correlation

```{r}
cor_proteins <- read_csv("data/processed/hooking.correlation.above.0.7.csv")

exclude_assays_controls <- 
  data_ht |> 
  filter(AssayType %in% control_assays) |> 
  distinct(Assay) |> 
  pull(Assay)

cor_data <- 
  data |> 
  filter(!Assay %in% exclude_assays_controls,
         !DAid %in% control_samples,
         !Assay %in% replicate_assays) |> 
  select(DAid, Assay, NPX) |> 
  pivot_wider(names_from = Assay,
              values_from = NPX) |>  
  column_to_rownames("DAid") |> 
  scale() |> 
  cor(use = "complete.obs") 

olink_targets <- 
  read_csv("data/olink_targets/overlap_olink_platforms.csv")

annotation <- 
  olink_targets |> 
  left_join(ht_lod |> 
              mutate(Block = as.numeric(Block)) |> 
              select(Assay, Percentage_under_LOD, Block), by = "Assay") |>
  filter(!is.na(Assay)) |> 
  mutate(Pre_analytical_variation = ifelse(Assay %in% cor_proteins$value, "Yes", "No")) |> 
  column_to_rownames("Assay")

# All proteins
cor_data |> 
  pheatmap(show_rownames = F,
           show_colnames = F,
           annotation_col = annotation,
           annotation_colors = list("Pre_analytical_variation" = pal_binary,
                                    "Platform" = pal_platforms)) |> 
  as.ggplot()

ggsave(savepath("correlation_all_proteins.png"), h = 8, w = 10)

# Explore 1.5K
explore_1 <- 
  olink_targets |> 
  filter(Platform == "1.5K") |> 
  pull(Assay)

explore_1_filt  <- explore_1[explore_1 %in% colnames(cor_data)]

cor_data[explore_1_filt,explore_1_filt] |> 
  pheatmap(show_rownames = F,
           show_colnames = F,
           annotation_col = annotation,
           annotation_colors = list("Pre_analytical_variation" = pal_binary,
                                    "Platform" = pal_platforms)) |> 
  as.ggplot()

ggsave(savepath("correlation_all_proteins_1K.png"), h = 6, w = 8)

# Explore 3K
explore_2 <- 
  olink_targets |> 
  filter(Platform == "3K") |> 
  pull(Assay)

explore_2_filt  <- explore_2[explore_2 %in% colnames(cor_data)]

annotation_2 <- 
  annotation |> 
  select(-Pre_analytical_variation, -Platform)

cor_data[explore_2_filt,explore_2_filt] |> 
  pheatmap(show_rownames = F,
           show_colnames = F,
           annotation_col = annotation_2) |> 
  as.ggplot()

ggsave(savepath("correlation_all_proteins_3K.png"), h = 6, w = 8)

# Explore HT
explore_3 <- 
  olink_targets |> 
  filter(Platform == "HT") |> 
  pull(Assay)

explore_3_filt  <- explore_3[explore_3 %in% colnames(cor_data)]

cor_data[explore_3_filt,explore_3_filt] |> 
  pheatmap(show_rownames = F,
           show_colnames = F,
           annotation_col = annotation_2) |> 
  as.ggplot()

ggsave(savepath("correlation_all_proteins_HT.png"), h = 6, w = 8)

```

### Distribution

```{r}
cor_data <- 
  data |> 
  filter(!Assay %in% exclude_assays_controls,
         !DAid %in% control_samples,
         !Assay %in% replicate_assays) |> 
  select(DAid, Assay, NPX) |> 
  pivot_wider(names_from = Assay,
              values_from = NPX) |>  
  column_to_rownames("DAid") |> 
  scale() |> 
  cor(use = "complete.obs") 

olink_targets <- 
  read_csv("data/olink_targets/overlap_olink_platforms.csv")


```

## WCGNA

```{r}

```


# Biology

## PD

```{r}
de_meta <- 
  manifest |> 
  filter(Cohort == "PARD",
         DAid %in% data$DAid) |> 
  select(DAid, Disease = Diagnose) |> 
  mutate(Sex = NA,
         Age = NA,
         BMI = NA)

de_meta |> 
  count(Disease) |> 
  ggplot(aes(Disease, n, fill = Disease, color = Disease)) +
  geom_col() +
  geom_text(aes(label = n, y = n + 10)) +
  scale_fill_manual(values = c("grey", pal_phase2[["PARD_Per Svenningsson"]])) +
    scale_color_manual(values = c("grey", pal_phase2[["PARD_Per Svenningsson"]])) +
  theme_hpa(angled = T)

ggsave(savepath("pd_samples.png"), h = 5, w = 5)

de_data <- 
  data |> 
  filter(DAid %in% de_meta$DAid,
         !Assay %in% c("GBP1", "MAP2K1")) |> 
  select(DAid, Assay, NPX) |> 
  pivot_wider(names_from = "Assay", values_from = "NPX")
    
pd_res <- 
  de_limma_disease(data_wide = de_data, 
                   metadata = de_meta,
                   disease = "PD",
                   correct = F) |> 
  mutate(Disease = "PD")

plot_volcano(pd_res) + ggtitle("PD")
ggsave(savepath("volcano_pd.png"), h = 6, w = 6)

pd_top_prots <- 
  pd_res |> 
  head(4) |> 
  pull(Assay)
  
dat <- 
  data |> 
  filter(Assay %in% pd_top_prots) |> 
  left_join(manifest, by = "DAid") |>
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_"),
         Diagnose = ifelse(Diagnose == "healthy", paste(Diagnose, Cohort, sep = "_"), Diagnose)) 

order <- 
  dat |> 
  distinct(Cohort, Diagnose) |> 
  mutate(Cohort = factor(Cohort, levels = names(pal_phase2))) |> 
  arrange(Cohort) |> 
  pull(Diagnose)

dat |> 
  mutate(Diagnose = factor(Diagnose, levels = order)) |>
  filter(!grepl("back-up", Diagnose)) |> 
  ggplot(aes(Diagnose, PCNormalizedNPX, fill = Cohort, color = Cohort)) +
  geom_quasirandom(alpha = 0.7) +
  geom_boxplot(alpha = 0.3, outlier.color = NA, color = "grey20") +
  scale_color_manual(values = pal_phase2) +
  scale_fill_manual(values = pal_phase2) +
  facet_wrap(~Assay, scales = "free_y") +
  theme_hpa(angled = T) +
  ggtitle("PD - top proteins")

ggsave(savepath("pd_top_prots.png"), h = 10, w = 12)

 data |> 
  filter(Assay == "FN1") |> 
  left_join(manifest, by = "DAid") |>
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_"),
         Diagnose = ifelse(Diagnose == "healthy", paste(Diagnose, Cohort, sep = "_"), Diagnose)) |> 
  mutate(Diagnose = factor(Diagnose, levels = order)) |>
  filter(!grepl("back-up", Diagnose)) |> 
  ggplot(aes(Diagnose, PCNormalizedNPX, fill = Cohort, color = Cohort)) +
  geom_quasirandom(alpha = 0.7) +
  geom_boxplot(alpha = 0.3, outlier.color = NA, color = "grey20") +
  scale_color_manual(values = pal_phase2) +
  scale_fill_manual(values = pal_phase2) +
  facet_wrap(~Assay, scales = "free_y") +
  theme_hpa(angled = T) +
  ggtitle("PD - top proteins")


```

## Fibromyalgia

```{r}
de_meta <- 
  manifest |> 
  filter(Cohort == "FIBR",
         DAid %in% data$DAid) |> 
  select(DAid, Disease = Diagnose) |> 
  mutate(Sex = NA,
         Age = NA,
         BMI = NA)

de_meta |> 
  count(Disease) |> 
  ggplot(aes(Disease, n, fill = Disease, color = Disease)) +
  geom_col() +
  geom_text(aes(label = n, y = n + 5)) +
  scale_fill_manual(values = c(pal_phase2[["FIBR_Camilla Svensson"]], "grey")) +
    scale_color_manual(values = c(pal_phase2[["FIBR_Camilla Svensson"]], "grey")) +
  theme_hpa(angled = T)

ggsave(savepath("fibr_samples.png"), h = 5, w = 5)

de_data <- 
  data |> 
  filter(DAid %in% de_meta$DAid,
         !Assay %in% c("GBP1", "MAP2K1")) |> 
  select(DAid, Assay, NPX) |> 
  pivot_wider(names_from = "Assay", values_from = "NPX")
    
fibr_res <- 
  de_limma_disease(data_wide = de_data, 
                   metadata = de_meta,
                   disease = "fibromyalgia",
                   correct = F) |> 
  mutate(Disease = "fibromyalgia")

plot_volcano(fibr_res) + ggtitle("fibromyalgia")
ggsave(savepath("volcano_fibromyalgia.png"), h = 6, w = 6)

fibr_top_prots <- 
  fibr_res |> 
  head(4) |> 
  pull(Assay)
  
dat <- 
  data |> 
  filter(Assay %in% fibr_top_prots) |> 
  left_join(manifest, by = "DAid") |>
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_"),
         Diagnose = ifelse(Diagnose == "healthy", paste(Diagnose, Cohort, sep = "_"), Diagnose)) 

order <- 
  dat |> 
  distinct(Cohort, Diagnose) |> 
  mutate(Cohort = factor(Cohort, levels = names(pal_phase2))) |> 
  arrange(Cohort) |> 
  pull(Diagnose)

dat |> 
  mutate(Diagnose = factor(Diagnose, levels = order)) |>
  filter(!grepl("back-up", Diagnose)) |> 
  ggplot(aes(Diagnose, PCNormalizedNPX, fill = Cohort, color = Cohort)) +
  geom_quasirandom(alpha = 0.7) +
  geom_boxplot(alpha = 0.3, outlier.color = NA, color = "grey20") +
  scale_color_manual(values = pal_phase2) +
  scale_fill_manual(values = pal_phase2) +
  facet_wrap(~Assay, scales = "free_y") +
  theme_hpa(angled = T) +
  ggtitle("Fibromialgya - top proteins")

ggsave(savepath("fibr_top_prots.png"), h = 10, w = 12)

```


## Epilepsy

```{r}

```


## BAMSE

```{r}

```


## Pregnancy

```{r}

```

## Wellness

```{r}


```

--------------

# Others

```{r}
data_ht_da |> 
  distinct(SampleID, SampleType) |> 
  filter(SampleType == "SAMPLE") 

data_ht_da |> 
  group_by(Assay) |> 
  summarize(n = n_distinct(SampleID)) |> arrange(n)
#1,032 samples
#5,416 proteins

exclude_assays <- 
  data_ht_da |> 
  distinct(Assay) |> filter(grepl("control", Assay, ignore.case = T) == T) |> 
  pull()

data_ht_da |>  
  distinct(Assay) |> 
  filter(!Assay %in% exclude_assays) |> 
  nrow()


data <- 
  data_ht_da |> 
  filter(SampleType == "SAMPLE",
         !Assay %in% exclude_assays) 


#samples <- 
data |> 
  distinct(SampleID) |> 
  separate(SampleID, into = c("DAid", "Plate"), sep = "-") |>
  left_join(manifest, by = "DAid") |> 
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_")) |>
  count(Cohort) |> 
  ggplot(aes(Cohort, n)) +
  geom_col() +
  geom_text(aes(label = n), vjust = -0.5) +
 # theme_hpa(angled = T) +
  ylab("Number of samples")

ggsave(savepath("da_phase2_cohorts_delivery1.png"), h = 5, w = 5)

savepath <- 
  function(savename) { 
    result_folder <- paste0("results/", Sys.Date())
    dir.create(result_folder, showWarnings = FALSE)
    
    savename <-
      paste0(result_folder, "/", savename)
    
    
    return(savename)
    
  }

savepath_folder <- 
  function(folder, savename) { 
    result_folder <- paste0("results/", Sys.Date(), "/",folder)
    dir.create(result_folder, showWarnings = FALSE)
    
    savename <-
      paste0(result_folder, "/", savename)
    
    
    return(savename)
    
  }

theme_hpa <- 
  function(angled = F, axis_x = T, axis_y = T, facet_title = T) {
    t <- 
      theme(
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.spacing = unit(0.2, "lines"), 
        panel.background=element_rect(fill="white"),
        panel.border = element_blank(),
        plot.title = element_text(face = "bold",
                                  size = rel(1), hjust = 0.5),
        plot.subtitle=element_text(face = "bold",hjust = 0.5, size=rel(1),vjust=1),
        axis.title = element_text(face = "bold",size = rel(1)),
        axis.ticks.length = unit(.25, "cm"),
        axis.line = element_line(linewidth = 0.5),
        axis.text = element_text(size = rel(1), color = 'black'),
        legend.key = element_blank(),
        legend.position = "right",
        legend.text = element_text(size=rel(0.8)),
        legend.key.size= unit(0.7, "cm"),
        legend.title = element_text(size=rel(1)),
        plot.margin=unit(c(10,5,5,5),"mm"),
        strip.background=element_rect(colour="grey90",fill="grey90"),
        strip.text = element_text(face="bold")
      )
    
    if(angled) {
      t <- t + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 
    }
    
    if(axis_x == F) {
      t <- t +
        theme(axis.text.x = element_blank(),
              axis.ticks.x = element_blank(),
              axis.line.x = element_blank(),
              axis.title.x = element_blank())
    } 
    
    if(axis_y == F) {
      t <- t +
        theme(axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              axis.line.y = element_blank(),
              axis.title.y = element_blank())
    }
    if(facet_title == F) {
      t <- t + theme(strip.text = element_blank())
    }
    return(t)
  }


library(ggrain)
library(ggsci)
library(ggrepel)

meta_2 <- 
  data |> 
  distinct(SampleID) |> 
  separate(SampleID, into = c("DAid", "Plate"), sep = "-") |>
  left_join(manifest, by = "DAid")


raincloud_data <- 
  data |> 
  separate(SampleID, into = c("DAid", "Plate"), sep = "-") |>
  left_join(meta_2 |> 
              select(-Plate), by = "DAid") |> 
  group_by(Cohort, Assay) |> 
  summarise(avg_NPX = mean(NPX))



raincloud_data %>% 
  ggplot(aes(x = Cohort, y = avg_NPX, fill = Cohort, color = Cohort)) +
  geom_rain(rain.side = 'l', alpha = 0.6, 
            boxplot.args.pos = list(position = ggpp::position_dodgenudge(x = .095), width = .1)) +
  scale_color_aaas() +
  scale_fill_aaas() + 
  geom_text_repel(aes(label = Assay)) +
  theme_hpa() +
  ggtitle("Disease Atlas Phase 2 Delivery 1 - NPX distribution") 

ggsave("da_phase2_cohorts_delivery1_npx.png", h = 9, w = 12)


#samples <- 
data |> 
  distinct(SampleID) |> 
  separate(SampleID, into = c("DAid", "Plate"), sep = "-") |>
  left_join(manifest, by = "DAid") |> 
  mutate(Cohort = paste(Cohort, `PI - sample owner`, sep = "_")) |>
  count(Cohort) |> 
  ggplot(aes(Cohort, n, fill = Cohort)) +
  geom_col() +
  scale_fill_aaas() + 
  geom_text(aes(label = n), vjust = -0.5) +
  theme_hpa(angled = T) +
  ylab("Number of samples")

ggsave(savepath("da_phase2_cohorts_delivery1.png"), h = 6, w = 6)

```

# Relevant assays

## COL9A1

```{r}
data |> 
  filter(Assay == "COL9A1") |> 
  left_join(manifest, by = "DAid") |>
  filter(Cohort %in% "BAMS") |> 
  filter(!grepl("back-up", Diagnose)) |> 
  mutate(Age_group = case_when(grepl("^4_", Diagnose) ~ 4,
                             grepl("8_", Diagnose) ~ 8,
                             grepl("16_", Diagnose) ~ 16,
                             grepl("24_", Diagnose) ~ 24), 
         Age_group = factor(Age_group, levels = c(4, 8, 16, 24))) |> 
  ggplot(aes(Age_group, PCNormalizedNPX, fill = Age_group, color = Age_group)) +
  geom_quasirandom(alpha = 0.7) +
  geom_boxplot(alpha = 0.3, outlier.color = NA, color = "grey20") +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  #scale_color_manual(values = pal_phase2) +
  #scale_fill_manual(values = pal_phase2) +
  #facet_wrap(~Assay, scales = "free_y") +
  theme_hpa(angled = T) +
  ggtitle("BAMSE - COL9A1")

ggsave(savepath("BAMSE_COL9A1.png"), h = 5, w = 5)
```

